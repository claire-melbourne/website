import React, { createElement, Fragment, useEffect, useRef } from 'react';
import { createRoot } from 'react-dom/client';
import cn from 'classnames'
import algoliasearch from "algoliasearch"
import { autocomplete, getAlgoliaResults } from '@algolia/autocomplete-js';
import {
  InstantSearch,
  useSearchBox
} from "react-instantsearch-hooks-web"


export const searchClient = algoliasearch("VTSKZ0Z9CR","53d6a35f0170907910d2631169af45a8")

export function SearchItem({ hit, components, activeItemId }) {
  const currentSelectedId = hit.__autocomplete_id
  return (
    <div className={`rounded cursor-pointer`}>
      <a className="block m-3" href={`docs${hit.slug}`}>
        <div className="flex flex-col gap-0.5">
          <div className={`text-sm font-semibold truncate ${currentSelectedId === activeItemId ? 'text-white' : 'text-primary-600 dark:text-primary-600'}`}>
            {hit.title}
          </div>
          <div className={`text-sm truncate ${currentSelectedId === activeItemId ? 'text-white' : 'text-gray-800'}`}>
            {hit.description}
          </div>
          <div
            className={`text-xs mt-0.5 truncate ${currentSelectedId === activeItemId ? 'text-white' : 'text-gray-500'}`}
          >
            {"Http-api  â€º  Cloudfront"}
          </div>
        </div>
      </a>
    </div>
  );
}

export function Autocomplete(props) {
  const containerRef = useRef(null);
  const panelRootRef = useRef(null);
  const rootRef = useRef(null);

  useEffect(() => {
    if (!containerRef.current) {
      return undefined;
    }

    const search = autocomplete({
      container: containerRef.current,
      renderer: { createElement, Fragment, render: () => {} },
      render({ children }, root) {
        if (!panelRootRef.current || rootRef.current !== root) {
          rootRef.current = root;

          panelRootRef.current?.unmount();
          panelRootRef.current = createRoot(root);
        }

        panelRootRef.current.render(children);
      },
      ...props,
    });

    return () => {
      search.destroy();
    };
  }, [props]);

  return <div ref={containerRef} />;
}

export default () => {
  return (
      <Autocomplete
        placeholder="Search"
        openOnFocus={true}
        getSources={({ query }) => {
          return [
          {
            sourceId: 'docs',
            getItems() {
              return getAlgoliaResults({
                searchClient,
                queries: [
                  {
                    indexName: 'fc-docs',
                    query,
                  },
                ],
              });
            },
            templates: {
              item({ item, components, state }) {
                return <SearchItem hit={item} components={components} activeItemId={state.activeItemId} />;
              },
            },
          },
        ]
        }}
      />
  )
}